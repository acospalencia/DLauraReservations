@model IEnumerable<DLaura.BusinessLogic.DTOs.ReservationResponse>

@{
    ViewData["Title"] = "MisReservaciones";
}

<div class="container mb-5 mt-4">
    <div class="row">
        <div>
            <h3>Acreedor de Recompensa por Frecuencia.</h3>
        </div>

        <div class="progress mb-4" role="progressbar" aria-label="Basic example" aria-valuenow="0" aria-valuemin="0" aria-valuemax="10">
            <div class="progress-bar " id="progressBar" style="width: 0%"></div>
        </div>
    </div>

    <div class="row">
        <div class="col">
            <div class="h3">
                <div class="reservaciones-actuales">
                    Reservaciones Actuales
                </div>
            </div>
            <div class="p">
                <div class="text-7" id="currentReservations">
                    0
                </div>
            </div>
        </div>
        <div class="col">
            <div class="h3-1">
                <div class="prxima-recompensa">
                    Próxima Recompensa
                </div>
            </div>
            <div class="p-1">
                <div class="text-3-reservas-ms" id="reservationsToGo">
                    10 reservas más
                </div>
            </div>
        </div>
    </div>
</div>

<h3>Historial de reservaciones</h3>


<table class="table text-center">
    <thead>
        <tr>
            <th>
                Fecha Reservada
            </th>
            <th>
                Turno Reservado
            </th>
            <th>
                Mesa Reservada
            </th>


        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model)
        {
            <tr>
                <td>
                    @Html.DisplayFor(modelItem => item.ReservationDate)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.ReservateShift)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.TableNumber)
                </td>
            </tr>
        }
    </tbody>
</table>

@Html.AntiForgeryToken()

<script>
    document.addEventListener("DOMContentLoaded", function () {
        var reservations = @Html.Raw(Json.Serialize(Model));  

        var totalReservations = reservations.length; 
        var maxReservations = 10; 

        document.getElementById("currentReservations").textContent = totalReservations;

        if(totalReservations >= 10){
            var userId = @User.FindFirst("Id")?.Value;
            
            console.log("Intentando aplicar compensación para usuario:", userId);
            
            // Obtener el token antifalsificación
            var token = document.querySelector('input[name="__RequestVerificationToken"]').value;
            
            fetch('@Url.Action("AplicarCompensacion", "Reservations")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': token
                },
                body: JSON.stringify(userId)
            })
            .then(response => {
                console.log("Respuesta del servidor:", response);
                if (!response.ok) {
                    throw new Error('Error en la respuesta del servidor');
                }
                return response.json();
            })
            .then(data => {
                console.log("Datos recibidos:", data);
                if (data.success) {
                    document.getElementById("currentReservations").textContent = `${totalReservations} / 10 - ¡Recompensa aplicada!`;
                    alert("¡Felicidades! Has alcanzado 10 reservaciones y se te ha aplicado una recompensa.");
                } else {
                    console.error("Error al aplicar recompensa:", data.message);
                    alert("Error: " + data.message);
                }
            })
            .catch(error => {
                console.error('Error en la petición:', error);
                alert("Error al aplicar la compensación: " + error.message);
            });
        }

        var reservationsLeft = maxReservations - totalReservations;
        if (reservationsLeft < 0) reservationsLeft = 0;
        document.getElementById("reservationsToGo").textContent = `${reservationsLeft} reservas más`;

        var progressPercentage = (totalReservations / maxReservations) * 100;
        if (progressPercentage > 100) progressPercentage = 100;
        var progressBar = document.getElementById("progressBar");
        progressBar.style.width = progressPercentage + "%";
        progressBar.setAttribute("aria-valuenow", totalReservations); 
    });
</script>